import{__awaiter as e}from"tslib";class r{constructor(){this.compress=r=>e(this,[r],void 0,(function*({blob:e,quality:r,targetWidth:t,targetHeight:o}){return new Promise(((i,n)=>{const a=new Worker(new URL("./compressor.worker.js?worker",import.meta.url),{type:"module"});a.onmessage=e=>{e.data.success||(console.error(e.data),n(new Error(e.data.error))),i(e.data)},a.onerror=e=>{n(e)},a.postMessage({blob:e,quality:r,targetWidth:t,targetHeight:o})}))}))}}var t;!function(e){e.gif="gif",e.heic="heic",e.heif="heif",e.webp="webp",e.jpeg="jpeg",e.png="png",e.bmp="bmp",e.avif="avif"}(t||(t={}));class o{decode(r){return e(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{const o=new Worker(new URL("./heif.worker.js?worker",import.meta.url),{type:"module"});o.onmessage=r=>{r.data.success||t(new Error(r.data.error)),e(r.data)},o.onerror=e=>{t(e)},o.postMessage({file:r,command:"decode"})}))}))}}class i{decode(r){return e(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{const o=new Worker(new URL("./simple.worker.js?worker",import.meta.url),{type:"module"});o.onmessage=r=>{r.data.success||t(new Error(r.data.error)),e(r.data)},o.onerror=e=>{t(e)},o.postMessage({file:r,command:"decode"})}))}))}}class n{static createDecoder(e){switch(e){case t.heic:case t.heif:return new o;default:return new i}}}class a{encode(r,t){return e(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const i=new Worker(new URL("./simple.worker.js?worker",import.meta.url),{type:"module"});i.onmessage=r=>{e(r.data)},i.onerror=e=>{o(e)},i.postMessage({blob:r,targetMimeType:t,command:"encode"})}))}))}}class s{static createEncoder(e){return new a}}class c{constructor(){this.supportedEncodeFormats=[t.jpeg,t.png,t.webp]}determineMimeType(e){return e.type}mimeTypeToFormat(e){switch(e){case"image/gif":return t.gif;case"image/heic":return t.heic;case"image/heif":return t.heif;case"image/webp":return t.webp;case"image/jpeg":default:return t.jpeg;case"image/png":return t.png;case"image/bmp":return t.bmp;case"image/avif":return t.avif}}formatToMimeType(e){switch(e){case t.gif:return"image/gif";case t.heic:return"image/heic";case t.heif:return"image/heif";case t.webp:return"image/webp";case t.jpeg:return"image/jpeg";case t.png:return"image/png";case t.bmp:return"image/bmp";case t.avif:return"image/avif";default:return"image/jpeg"}}process(t,o){return e(this,void 0,void 0,(function*(){if(!window.Worker)throw new Error("Web Workers are not supported in this environment");if(!window.OffscreenCanvas)throw new Error("OffscreenCanvas is not supported in this environment");if(!this.supportedEncodeFormats.includes(o.format))throw new Error("Encoding to this format is not supported yet");const e=this.determineMimeType(t),i=this.mimeTypeToFormat(e),[a,c]=o.resize,m=o.format,d=n.createDecoder(i),p=yield d.decode(t),u=new r,g=yield u.compress({blob:p.blob,quality:o.quality,targetWidth:a,targetHeight:c}),w=s.createEncoder(m),l=this.formatToMimeType(m);return(yield w.encode(g.blob,l)).blob}))}downloadFile(e,r){const t=URL.createObjectURL(e),o=document.createElement("a");o.href=t,o.download=r,document.body.appendChild(o),o.click(),URL.revokeObjectURL(t),document.body.removeChild(o)}}export{t as PictureFormat,c as PictureOperator};
